---

title: Active Directory Pentest -PART 1-
date: 2025-11-10 18:00 +0100
categories: [Pentesting, Active Directory]
tags: [active-directory, pentest, cheat-sheet]
author: F1Z3R
-------------

## Active Directory: A Short Overview

**Active Directory (AD)** is Microsoft‚Äôs centralized directory service that manages users, computers, and resources across a network. Its core purpose is **authentication and authorization** ‚Äî ensuring the right people access the right systems.

---

## The Core Structure: Domains, Trees, and Forests

Active Directory follows a logical hierarchy:

* **Domain:** The basic unit ‚Äî a collection of objects (users, computers, etc.) sharing a database and policies.
  *Example:* `company.com`
* **Tree:** A group of one or more domains under a contiguous namespace.
  *Example:* `company.com` and `us.company.com`
* **Forest:** The top-level container ‚Äî one or more trees sharing a common schema and global catalog. It defines the **security boundary** of an organization.

---

## Key Components & Services

* **AD DS (Domain Services):** Stores directory info, manages logins, and enforces security policies.
* **Domain Controllers (DCs):** Servers hosting the AD DS database.
* **Objects:** Core elements like **Users**, **Groups**, **Computers**, and **Organizational Units (OUs)** ‚Äî containers used to structure and apply policies.

---

## Essential AD-Related Services

* **AD CS (Certificate Services):** Manages PKI certificates for secure communication.
* **AD LDS (Lightweight Directory Services):** Simplified directory for apps without a full domain.
* **AD FS (Federation Services):** Enables **Single Sign-On (SSO)** across multiple apps.
* **DNS:** Critical for locating domain controllers and services across the network.

---

## Reconnaissance with No Credentials / Session

> üß† **Note:** All examples below are for **authorized testing** only (internal labs, red team, or CTF environments).

---

### 1Ô∏è‚É£ Initial Scanning ‚Äî Nmap (cmdline examples)

```bash
# Basic scan
$ nmap -sC -sV -T4 <IP>

# Full TCP scan
$ nmap -p- --min-rate 5000 -oA scans/nmap_full <IP>

# Top UDP ports
$ nmap -sU --top-ports 5000 <IP>

# Comprehensive UDP scan
$ nmap -sU -p- <IP>

# Combined TCP + UDP
$ nmap -sS -sU --top-ports 1000 <IP>
```

---

### 2Ô∏è‚É£ Examining Open Ports

#### üß© SMB (Port 445)

**SMB (Server Message Block)** allows access to shared files, printers, and resources. Always check for accessible shares ‚Äî even without credentials.

```bash
# Full enumeration with enum4linux
$ enum4linux -a <IP>
```

#### üîç List Shared Folders (cmdline)

```bash
# List shares using smbclient (null session)
$ smbclient --no-pass -L //<IP>

# List shares with credentials (will prompt for a password if omitted)
$ smbclient -U 'username' -L //<IP>

# Enumerate with smbmap (null)
$ smbmap -H <IP>

# Enumerate with smbmap (auth)
$ smbmap -u "username" -p "password" -H <IP>

# Pass-the-hash with smbmap
$ smbmap -u "username" -p "<NT>:<LM>" -H <IP>
```

```bash
# CrackMapExec (null session)
$ crackmapexec smb <IP> -u '' -p '' --shares

# CrackMapExec with creds
$ crackmapexec smb <IP> -u 'username' -p 'password' --shares

# CrackMapExec pass-the-hash
$ crackmapexec smb <IP> -u 'username' -H '<HASH>' --shares
```

#### Connect and Browse Shares (cmdline)

```bash
# Connect using smbclient (null session)
$ smbclient -U '%' -N \\<IP>\<SHARE>

# Connect using smbclient (auth)
$ smbclient -U '<USER>' \\<IP>\<SHARE>
```

Common shares: `C$`, `D$`, `ADMIN$`, `IPC$`, `SYSVOL`, `NETLOGON`

```bash
# Download files recursively after connecting with smbclient
> mask ""
> recurse
> prompt
> mget *

# Or use smbmap to search and download
$ sudo smbmap -R Folder -H <IP> -A <FileName> -q
```

---

### 2.3- HTTP/HTTPS : Port 80 / 443

Looking for any entry point from attacking the web interface. Web pentesting content and full writeups will be released soon.

---

### 2.4- RPC : Remote Procedure Call (cmdline examples)

**RPC** (Remote Procedure Call) allows programs to execute procedures on remote systems as if local. It's heavily used by Windows services and AD.

```bash
# Null session connection (interactive)
$ rpcclient -U "" <target_ip>

# Empty username (-U "") and no password (-N)
$ rpcclient -U "" -N <target_ip>

# Authenticated connection with username and password
$ rpcclient -U "<username>%<password>" <target_ip>

# Domain authenticated connection
$ rpcclient -U "<domain>/<username>%<password>" <target_ip>

# Get server information
$ rpcclient <target_ip> -c "srvinfo"

# Enumerate domain users
$ rpcclient <target_ip> -c "enumdomusers"

# Enumerate domain groups
$ rpcclient <target_ip> -c "enumdomgroups"

# Query domain information
$ rpcclient <target_ip> -c "querydominfo"

# Get security identifier (SID)
$ rpcclient <target_ip> -c "lsaquery"

# Get SID of a specific user
$ rpcclient <target_ip> -c "lookupnames <username>"

# Get SID of a specific group
$ rpcclient <target_ip> -c "lookupnames <groupname>"

# Get RID (Relative ID) of a specific user
$ rpcclient <target_ip> -c "samrlookupnames <username>"

# Enumerate privileges
$ rpcclient <target_ip> -c "enumprivs"

# Get password policy information
$ rpcclient <target_ip> -c "getdompwinfo"

# List members of a specific group by RID
$ rpcclient <target_ip> -c "querygroupmem <group_rid>"

# Enumerate shared resources
$ rpcclient <target_ip> -c "netshareenum"

# Get information on a specific share
$ rpcclient <target_ip> -c "netsharegetinfo <sharename>"

# Enumerate all SIDs
$ rpcclient <target_ip> -c "lsaenumsid"

# Query trusted domains
$ rpcclient <target_ip> -c "lsaquerytrustdom"

# Enumerate alias groups
$ rpcclient <target_ip> -c "enumalsgroups"

# Enumerate account rights for a given SID
$ rpcclient <target_ip> -c "lsaenumacctrights <SID>"
```

---

### 3Ô∏è‚É£ LDAP (Ports 389 / 636) ‚Äî cmdline examples

**LDAP** is the network "phonebook" used to query AD objects.

```bash
# Anonymous bind (null credentials)
$ ldapsearch -x -H ldap://<IP> -D '' -w '' -b "DC=<SUBDOMAIN>,DC=<TLD>"

# Authenticated bind
$ ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<username>' -w '<password>' -b "DC=<SUBDOMAIN>,DC=<TLD>"
```

#### NetExec / CME LDAP enumeration

```bash
# Enumerate objects from root DSE (null bind)
$ netexec ldap <DC_FQDN> -u '' -p '' --query "(objectClass=*)" ""

# Dump user sAMAccountName attributes
$ netexec ldap <DC_FQDN> -u '' -p '' --query "(sAMAccountName=*)" "" \
  | awk -F': ' '/sAMAccountName:/ {print $2}' | sort -u > users.txt
```

#### Dump domain with authenticated creds

```bash
$ pip3 install ldapdomaindump
$ ldapdomaindump <IP> -u '<domain>\<username>' -p '<password>' --no-json --no-grep -o /path/dir
```

---

### LDAP Queries ‚Äî Quick Reference (cmdline)

```bash
# All data
$ ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<user>' -w '<pass>' -b "DC=<SUBDOMAIN>,DC=<TLD>"

# Users
$ ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<user>' -w '<pass>' -b "CN=Users,DC=<SUBDOMAIN>,DC=<TLD>"

# Computers
$ ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<user>' -w '<pass>' -b "CN=Computers,DC=<SUBDOMAIN>,DC=<TLD>"

# Domain Admins
$ ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<user>' -w '<pass>' -b "CN=Domain Admins,CN=Users,DC=<SUBDOMAIN>,DC=<TLD>"

# Remote Desktop Users
$ ldapsearch -x -H ldap://<IP> -D '<DOMAIN>\<user>' -w '<pass>' -b "CN=Remote Desktop Users,CN=Builtin,DC=<SUBDOMAIN>,DC=<TLD>"
```

Search for leaked password attributes:

```bash
$ <ldapsearchcmd...> | grep -i -A2 -B2 "userpas"
```

> ‚ö†Ô∏è The values returned by LDAP may contain obfuscated or non-plaintext password-like fields. Treat anything found as potential leads ‚Äî verify safely in an authorized environment.

---

## Final Notes

Reconnaissance in Active Directory environments is **pattern recognition** ‚Äî each open port is a door to context.

If you can‚Äôt authenticate, enumerate.
If you can authenticate, **extract structure**.

> **Hack. Learn. Enumerate. Repeat.**

---

*Written by F1Z3R ‚Äî November 2025*
*‚ÄúWe enumerate to understand.‚Äù*
